{
  "hash": "fbaecbc4b5a0b5090a3f9c9942344b45",
  "result": {
    "markdown": "---\ntitle: \"4 - Qualité de la décomposition sous R\"\n---\n\n\n\n\n\n> L'objectif de ce TP est d'apprendre à étudier la qualité de la décomposition depuis RJDemetra.\n\n\nPour installer tous les packages utiles de ce TP, lancer le programme :\n\n\n::: {.cell}\n\n```{.r .cell-code}\npackages_to_install <- c(\"RJDemetra\", \"remotes\")\n\npackages <- packages_to_install[! packages_to_install %in% installed.packages()[,\"Package\"]]\nif (length(packages) > 0) {\n\tinstall.packages(packages)\n}\npackages_to_install_git <- c(\"rjd3toolkit\", \"rjd3x13\", \"rjd3tramoseats\", \"rjd3providers\", \"rjdemetra3\")\npackages_git <- packages_to_install_git[! packages_to_install_git %in% installed.packages()[,\"Package\"]]\n\nif (length(packages_git) > 0) {\n\t# # Configurer si besoin le proxy\n\t# proxy <- \"proxy_a_definir\"\n\t# Sys.setenv(HTTPS_PROXY = proxy)\n\tremotes::install_github(\n\t\tsprintf(\"rjdemetra/%s\", packages_git),\n\t\t# option utile dans certaines installations portables de Java :\n\t\tINSTALL_opts = \"--no-multiarch\")\n}\n```\n:::\n\n\n\nDans ce TP nous allons voir différentes façon de vérifier la qualité de la décomposition.\nTout d'abord, on peut commencer par regarder les statistiques m dont les définitions sont rappelées ci-dessous\n\n\n::: {.cell}\n::: {.cell-output-display}\n|    | Poids |Description                                                                                                                                          |Si problème                            |\n|:---|:-----:|:----------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------|\n|M1  |  10   |Contribution de l'irrégulier à la variance totale (stationnarisation par différence d'ordre 3). Si trop élevé, difficile d'extraire la saisonnalité. |Points atypiques ou taille des filtres |\n|M2  |  11   |Contribution de l'irrégulier à la variance totale (stationnarisation par une droite).                                                                |Points atypiques ou taille des filtres |\n|M3  |  10   |Mesuré à partir du ratio I/C. Si trop grand on aura du mal à séparer les deux composantes.                                                           |Points atypiques ou taille des filtres |\n|M4  |   8   |Test autocorrélation sur l'irrégulier (réduire le filtre saisonnier).                                                                                |Filtre saisonnier plus court           |\n|M5  |  11   |Mesuré à partir du MCD (nombre de mois nécessaires pour que les variations absolues de la TC l'emporte sur I).                                       |Points atypiques                       |\n|M6  |  10   |Vérifie si la moyenne mobile M3x5 est appropriée ($1.5 < I/S < 6.5$).                                                                                |Prendre filtre plus long               |\n|M7  |  18   |Permet de voir si la saisonnalité est identifiable (compare part relative de la saisonnalité stable et mobile).                                      |Schéma multiplicatif ?                 |\n|M8  |   7   |Mesure l'évolution de la S de court terme.                                                                                                           |Changer filtre saisonnier              |\n|M9  |   7   |Mesure l'évolution de la S de long terme.                                                                                                            |Changer filtre saisonnier              |\n|M10 |   4   |M8 sur dernières années ($N-2$ à $N-5$).                                                                                                             |Changer filtre saisonnier              |\n|M11 |   4   |M9 sur dernières années ($N-2$ à $N-5$).                                                                                                             |Changer filtre saisonnier              |\n:::\n:::\n\n\n# `RJDemetra`\n\nPrenons une spécification par défaut :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(RJDemetra)\nipi_fr <- ipi_c_eu[, \"FR\"]\nmysa <- x13(ipi_fr, \"RSA4\")\n```\n:::\n\n\nÀ partir d'un objet `\"X13\"`, les statistiques m disponibles dans la sous-liste `.$decomposition` :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa$decomposition\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMonitoring and Quality Assessment Statistics:\n      M stats\nM(1)    0.127\nM(2)    0.079\nM(3)    1.094\nM(4)    0.558\nM(5)    1.093\nM(6)    0.022\nM(7)    0.085\nM(8)    0.242\nM(9)    0.064\nM(10)   0.261\nM(11)   0.247\nQ       0.355\nQ-M2    0.389\n\nFinal filters: \nSeasonal filter:  3x5\nTrend filter:  13 terms Henderson moving average\n```\n:::\n:::\n\n\n::: callout-note\n## Exercice\nQue signifie ces valeurs des statistiques m plus grandes que 1 ?\nEst-ce important ? \nSi oui comment les corriger ?\n:::\n\n::: {.callout-caution collapse=\"true\"}\n## Indice\nQue pensez-vous de la tendance (`plot(mysa$final, type_chart = \"sa-trend\")`) ? \nQuelle est la contribution du cycle à la variance totale (`mysa$diagnostics$variance_decomposition`) ? \n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\nLa tendance est plutôt plate et la contribution du cycle à la variance totale est petite, on peut donc ignorer la statistique m3. \nLa statistique M5 suggère de prendre un filtre saisonnier plus long, par exemple en utilisant le code suivant :\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa2 <- x13(get_ts(mysa), x13_spec(mysa, x11.seasonalma = \"S3X9\"))\nmysa2$decomposition\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMonitoring and Quality Assessment Statistics:\n      M stats\nM(1)    0.287\nM(2)    0.151\nM(3)    1.490\nM(4)    1.228\nM(5)    1.385\nM(6)    0.322\nM(7)    0.087\nM(8)    0.163\nM(9)    0.062\nM(10)   0.133\nM(11)   0.127\nQ       0.541\nQ-M2    0.595\n\nFinal filters: \nSeasonal filter:  3x9\nTrend filter:  23-Henderson\n```\n:::\n\n```{.r .cell-code}\nmysa2$diagnostics\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRelative contribution of the components to the stationary\nportion of the variance in the original series,\nafter the removal of the long term trend\n Trend computed by Hodrick-Prescott filter (cycle length = 8.0 years)\n           Component\n Cycle         1.728\n Seasonal     51.002\n Irregular     1.253\n TD & Hol.     2.178\n Others       44.904\n Total       101.065\n\nCombined test in the entire series\n Non parametric tests for stable seasonality\n                                                          P.value\n   Kruskall-Wallis test                                      0.000\n   Test for the presence of seasonality assuming stability   0.000\n   Evolutive seasonality test                                0.035\n \n Identifiable seasonality present\n\nResidual seasonality tests\n                                      P.value\n qs test on sa                          0.066\n qs test on i                           0.286\n f-test on sa (seasonal dummies)        0.889\n f-test on i (seasonal dummies)         0.845\n Residual seasonality (entire series)   0.757\n Residual seasonality (last 3 years)    0.948\n f-test on sa (td)                      0.102\n f-test on i (td)                       0.277\n```\n:::\n:::\n\n\nMais en faisant cela on crée de la saisonnalité résiduelle ! C'est donc mieux de rester sur les paramètres par défaut.\n:::\n\nAlors que pour changer le filtre saisonnier il suffit d'utiliser le paramètre `x11.seasonalma`, pour changer la longueur du filtre de Henderson il faut désactiver l'option de recherche automatique de la longueur du filtre (`x11.trendAuto = FALSE`) et spécifier la longueur dans le paramètre `x11.trendma`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_spec <- x13_spec(mysa, x11.trendma = 15)\nnew_spec$x11# Colonne trendma inchangée !\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            x11.mode x11.seasonalComp x11.lsigma x11.usigma x11.trendAuto\nPredefined Undefined             TRUE        1.5        2.5          TRUE\nUser_modif      <NA>               NA         NA         NA            NA\nFinal      Undefined             TRUE        1.5        2.5          TRUE\n           x11.trendma x11.seasonalma x11.fcasts x11.bcasts x11.calendarSigma\nPredefined          13            Msr         -1          0              None\nUser_modif          15           <NA>         NA         NA              <NA>\nFinal               13            Msr         -1          0              None\n           x11.sigmaVector x11.excludeFcasts\nPredefined              NA             FALSE\nUser_modif              NA                NA\nFinal                   NA             FALSE\n```\n:::\n\n```{.r .cell-code}\nnew_spec <- x13_spec(mysa, x11.trendma = 15, x11.trendAuto = FALSE)\nnew_spec$x11\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            x11.mode x11.seasonalComp x11.lsigma x11.usigma x11.trendAuto\nPredefined Undefined             TRUE        1.5        2.5          TRUE\nUser_modif      <NA>               NA         NA         NA         FALSE\nFinal      Undefined             TRUE        1.5        2.5         FALSE\n           x11.trendma x11.seasonalma x11.fcasts x11.bcasts x11.calendarSigma\nPredefined          13            Msr         -1          0              None\nUser_modif          15           <NA>         NA         NA              <NA>\nFinal               15            Msr         -1          0              None\n           x11.sigmaVector x11.excludeFcasts\nPredefined              NA             FALSE\nUser_modif              NA                NA\nFinal                   NA             FALSE\n```\n:::\n:::\n\n\nSur la qualité de la décomposition, la sous liste `.$diagnostics` contient les contributions des différentes composantes à la variance de la série, le test combiné et les tests sur la saisonnalité et jours ouvrables résiduels :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa$diagnostics\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRelative contribution of the components to the stationary\nportion of the variance in the original series,\nafter the removal of the long term trend\n Trend computed by Hodrick-Prescott filter (cycle length = 8.0 years)\n           Component\n Cycle         1.830\n Seasonal     51.089\n Irregular     0.927\n TD & Hol.     2.179\n Others       44.916\n Total       100.941\n\nCombined test in the entire series\n Non parametric tests for stable seasonality\n                                                          P.value\n   Kruskall-Wallis test                                      0.000\n   Test for the presence of seasonality assuming stability   0.000\n   Evolutive seasonality test                                0.014\n \n Identifiable seasonality present\n\nResidual seasonality tests\n                                      P.value\n qs test on sa                          0.924\n qs test on i                           0.643\n f-test on sa (seasonal dummies)        0.671\n f-test on i (seasonal dummies)         0.453\n Residual seasonality (entire series)   0.415\n Residual seasonality (last 3 years)    0.954\n f-test on sa (td)                      0.091\n f-test on i (td)                       0.333\n```\n:::\n:::\n\n\nCes tests sont effectués sur l'ensemble de la série, alors que dans le main result le f-test est effectué sur les 8 dernières années.\nIl n'est pour l'instant pas possible d'exporter les tests de saisonnalité résiduelle sur les 8 ou 10 dernières années.\nÀ partir du packages `rjd3toolkit` il est en revanche possible de calculer tous les tests à l'exception du f-test^[Entre JDemetra+ 2.x et JDemetra+ 3.x la spécification du f-test a été changée].\n\nPar rapport aux éléments vus en cours, les msr par mois sont exportables en utilisant le paramètre `userdefined` de `x13`.\nIl y a cependant actuellement un bug qui ne permet pas de l'exporter pour le dernier mois :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa <- x13(ipi_fr, \n\t\t\tuserdefined = c(\"diagnostics.msr-global\",\n\t\t\t\t\t\t\tsprintf(\"diagnostics.msr(%i)\", 1:12)))\nc(mysa$user_defined)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$`diagnostics.msr-global`\n[1] 4.224309\n\n$`diagnostics.msr(1)`\n[1] 6.918248\n\n$`diagnostics.msr(2)`\n[1] 4.679206\n\n$`diagnostics.msr(3)`\n[1] 4.351482\n\n$`diagnostics.msr(4)`\n[1] 5.808313\n\n$`diagnostics.msr(5)`\n[1] 4.446801\n\n$`diagnostics.msr(6)`\n[1] 3.175827\n\n$`diagnostics.msr(7)`\n[1] 5.102764\n\n$`diagnostics.msr(8)`\n[1] 2.756466\n\n$`diagnostics.msr(9)`\n[1] 4.216562\n\n$`diagnostics.msr(10)`\n[1] 4.750469\n\n$`diagnostics.msr(11)`\n[1] 5.088831\n\n$`diagnostics.msr(12)`\nNULL\n```\n:::\n:::\n\n\nPour extraire tous les MSR, préférer la solution suivante :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextract_msr <- function(x, i = 1:12){\n\tjmodel <- suppressWarnings(jx13(get_ts(x), x13_spec(x)))\n\tjres <- jmodel$result@internal$getResults()\n\tjres <- new(Class = \"X13_java\", internal = jres)\n\tres <- sapply(i, function(i_){\n\t\tRJDemetra:::result(jres,\n\t\t\t\t\t\t   sprintf(\"msr(%i)\", i_))\n\t})\n\tnames(res) <- sprintf(\"msr(%i)\", i)\n\tres\n}\nextract_msr(mysa)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  msr(1)   msr(2)   msr(3)   msr(4)   msr(5)   msr(6)   msr(7)   msr(8) \n6.918248 4.679206 4.351482 5.808313 4.446801 3.175827 5.102764 2.756466 \n  msr(9)  msr(10)  msr(11)  msr(12) \n4.216562 4.750469 5.088831 2.953120 \n```\n:::\n:::\n\n\n\n# `rjdemetra3`\n\nPrenons une spécification par défaut :\n\n\n\n\n\nLes statistiques m disponibles dans la sous-liste `.$result$mstats` :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsa_jd3$result$mstats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$m1\n[1] 0.1267867\n\n$m2\n[1] 0.07923419\n\n$m3\n[1] 1.094359\n\n$m4\n[1] 0.5580624\n\n$m5\n[1] 1.093318\n\n$m6\n[1] 0.02176204\n\n$m7\n[1] 0.08520675\n\n$m8\n[1] 0.2423733\n\n$m9\n[1] 0.06360174\n\n$m10\n[1] 0.2606264\n\n$m11\n[1] 0.247436\n\n$q\n[1] 0.3549944\n\n$qm2\n[1] 0.3890771\n```\n:::\n:::\n\n\n::: callout-note\n## Exercice\nQue signifie ces valeurs des statistiques m plus grandes que 1 ? Est-ce important ? \nSi oui comment les corriger ?\n:::\n\n::: {.callout-caution collapse=\"true\"}\n## Indice\nQue pensez-vous de la tendance (`plot(sa_jd3)`) ? \nQuelle est la contribution du cycle à la variance totale (`sa_jd3$result$diagnostics$vardecomposition` ou `rjd3toolkit::diagnostics(sa_jd3)[[1]]`) ? \n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\nLa tendance est plutôt plate et la contribution du cycle à la variance totale est petite, on peut donc ignorer la statistique m3. \nLa statistique M5 suggère de prendre un filtre saisonnier plus long, par exemple en utilisant le code suivant :\n\n::: {.cell}\n\n```{.r .cell-code}\nsa2_jd3 <- rjd3x13::x13(\n\tsa_jd3$result$preadjust$a1,\n\tsa_jd3$estimation_spec |> \n\t\trjd3x13::set_x11(seasonal.filter = \"S3X9\"))\nsa2_jd3$result$mstats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$m1\n[1] 0.2865214\n\n$m2\n[1] 0.1511407\n\n$m3\n[1] 1.490081\n\n$m4\n[1] 1.227737\n\n$m5\n[1] 1.38513\n\n$m6\n[1] 0.3221387\n\n$m7\n[1] 0.08654842\n\n$m8\n[1] 0.1630884\n\n$m9\n[1] 0.06162402\n\n$m10\n[1] 0.1329491\n\n$m11\n[1] 0.1266407\n\n$q\n[1] 0.5406235\n\n$qm2\n[1] 0.5948553\n```\n:::\n\n```{.r .cell-code}\nrjd3toolkit::diagnostics(sa2_jd3)[[\"residual_tests\"]]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               Statistic    P.value\nseas.ftest.i   0.8077490 0.63220978\nseas.ftest.sa  0.8422258 0.59838207\nseas.qstest.i  2.5023511 0.28616820\nseas.qstest.sa 5.4440142 0.06574267\ntd.ftest.i     1.1983675 0.30637684\ntd.ftest.sa    1.0445406 0.39599185\n                                                                                                   Description\nseas.ftest.i   F with 11.0 degrees of freedom in the nominator and 131.0 degrees of freedom in the denominator\nseas.ftest.sa  F with 11.0 degrees of freedom in the nominator and 131.0 degrees of freedom in the denominator\nseas.qstest.i                                                                Chi2 with 2.0 degrees of freedom \nseas.qstest.sa                                                               Chi2 with 2.0 degrees of freedom \ntd.ftest.i      F with 6.0 degrees of freedom in the nominator and 365.0 degrees of freedom in the denominator\ntd.ftest.sa     F with 6.0 degrees of freedom in the nominator and 365.0 degrees of freedom in the denominator\n```\n:::\n:::\n\n\nMais en faisant cela on crée de la saisonnalité résiduelle ! C'est donc mieux de rester sur les paramètres par défaut.\n:::\n\n\nPar rapport à `RJDemetra`, plus d'éléments associés aux MSR sont exportables :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsa_jd3 <- rjd3x13::x13(\n\tipi_fr, \"rsa4\", \n\tuserdefined = c(\"decomposition.d9-global-msr\", \n\t\t\t\t\t\"decomposition.d9-msr\", \n\t\t\t\t\t\"decomposition.d9-msr-table\")\n)\nc(sa_jd3$user_defined)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$`decomposition.d9-global-msr`\n[1] 4.054405\n\n$`decomposition.d9-msr`\n [1] 6.432093 4.778968 5.061714 4.681529 4.177106 3.200465 4.651325 2.617721\n [9] 3.885137 4.256683 6.629040 2.577652\n\n$`decomposition.d9-msr-table`\n          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]\n[1,] 0.9410370 0.8787867 1.0086908 0.7913817 1.0132386 0.8664120 0.8931384\n[2,] 0.1463034 0.1838863 0.1992785 0.1690434 0.2425695 0.2707145 0.1920181\n[3,] 6.4320925 4.7789676 5.0617144 4.6815286 4.1771062 3.2004645 4.6513246\n          [,8]      [,9]     [,10]     [,11]     [,12]\n[1,] 0.9665417 0.8704061 1.0876705 0.8972216 0.9300347\n[2,] 0.3692303 0.2240348 0.2555207 0.1353471 0.3608069\n[3,] 2.6177208 3.8851372 4.2566834 6.6290402 2.5776524\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}